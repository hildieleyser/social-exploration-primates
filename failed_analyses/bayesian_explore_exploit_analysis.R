# =============================================================================
# Bayesian Hierarchical Multinomial Regression Analysis
# Research Question: Does social context and expectation influence explore/exploit decisions?
# =============================================================================

# Set CRAN mirror
options(repos = c(CRAN = "https://cloud.r-project.org/"))

# Load required libraries
if (!require(pacman)) install.packages("pacman")
pacman::p_load(
  tidyverse,      # Data manipulation and visualization
  brms,           # Bayesian regression models using Stan
  bayesplot,      # Plotting for Bayesian models
  loo,            # Model comparison
  tidybayes,      # Tidy Bayesian analysis
  ggplot2,        # Plotting
  gridExtra,      # Grid arrangements for plots
  coda,           # MCMC diagnostics
  stringr,        # String manipulation
  data.table      # Fast data manipulation
)

# Set up parallel processing
options(mc.cores = parallel::detectCores())

# =============================================================================
# 1. DATA LOADING AND PREPROCESSING
# =============================================================================

# Load data
data <- read.csv("Explore Exploit Dataset.csv", stringsAsFactors = FALSE)

# Initial data exploration
cat("Dataset dimensions:", dim(data), "\n")
cat("Column names:\n")
print(names(data))

# =============================================================================
# 2. DATA CLEANING AND FEATURE ENGINEERING
# =============================================================================

# Create a cleaned dataset for analysis
data_clean <- data %>%
  # Remove empty rows
  filter(!is.na(monkey) & !is.na(CONDITION) & !is.na(OUTCOME)) %>%
  
  # Clean and categorize the OUTCOME variable
  mutate(
    # Create binary explore/exploit classification
    decision_type = case_when(
      str_detect(tolower(OUTCOME), "explore") ~ "explore",
      str_detect(tolower(OUTCOME), "exploit") ~ "exploit",
      TRUE ~ "other"
    ),
    
    # Clean social context (CONDITION)
    social_context = case_when(
      CONDITION == "solo" ~ "solo",
      CONDITION == "duo" ~ "duo",
      CONDITION == "trio" ~ "trio",
      TRUE ~ "other"
    ),
    
    # Create expectation variables
    expected_explore_cat = cut(expected_explore, 
                              breaks = c(0, 0.33, 0.66, 1), 
                              labels = c("low", "medium", "high"),
                              include.lowest = TRUE),
    
    # Standardize continuous predictors
    expected_explore_z = scale(expected_explore)[,1],
    subjective_exploit_z = scale(subjective_exploit)[,1],
    trial_num_z = scale(TRIAL_NUM)[,1],
    
    # Create hierarchical grouping variables
    monkey_id = factor(monkey),
    block_id = factor(BLOCK_No),
    trial_type_clean = factor(TRIAL_TYPE),
    
    # Create relative rank factor
    relative_rank_f = factor(RELATIVE_RANK),
    
    # Create interaction terms
    social_x_expectation = interaction(social_context, expected_explore_cat)
  ) %>%
  
  # Filter to only explore/exploit decisions
  filter(decision_type %in% c("explore", "exploit")) %>%
  
  # Remove missing values in key variables
  filter(!is.na(expected_explore) & !is.na(social_context) & 
         social_context != "other") %>%
  
  # Ensure we have enough data per group
  group_by(monkey_id, social_context) %>%
  filter(n() >= 10) %>%
  ungroup()

# Check data after cleaning
cat("\nAfter cleaning:\n")
cat("Dataset dimensions:", dim(data_clean), "\n")
cat("Unique monkeys:", length(unique(data_clean$monkey_id)), "\n")
cat("Social contexts:", table(data_clean$social_context), "\n")
cat("Decision types:", table(data_clean$decision_type), "\n")

# =============================================================================
# 3. DESCRIPTIVE STATISTICS AND VISUALIZATION
# =============================================================================

# Summary statistics by social context
summary_stats <- data_clean %>%
  group_by(social_context, decision_type) %>%
  summarise(
    count = n(),
    mean_expected_explore = mean(expected_explore, na.rm = TRUE),
    sd_expected_explore = sd(expected_explore, na.rm = TRUE),
    mean_subjective_exploit = mean(subjective_exploit, na.rm = TRUE),
    .groups = 'drop'
  )

print("Summary Statistics by Social Context:")
print(summary_stats)

# Visualization: Proportion of explore decisions by social context and expectation
p1 <- data_clean %>%
  group_by(social_context, expected_explore_cat) %>%
  summarise(
    explore_prop = mean(decision_type == "explore"),
    n = n(),
    .groups = 'drop'
  ) %>%
  ggplot(aes(x = expected_explore_cat, y = explore_prop, fill = social_context)) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(
    title = "Proportion of Explore Decisions by Social Context and Expectation",
    x = "Expected Explore Level",
    y = "Proportion of Explore Decisions",
    fill = "Social Context"
  ) +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent)

# Visualization: Individual monkey patterns
p2 <- data_clean %>%
  group_by(monkey_id, social_context) %>%
  summarise(
    explore_prop = mean(decision_type == "explore"),
    n = n(),
    .groups = 'drop'
  ) %>%
  ggplot(aes(x = social_context, y = explore_prop, color = monkey_id)) +
  geom_point(size = 3) +
  geom_line(aes(group = monkey_id), alpha = 0.7) +
  labs(
    title = "Individual Monkey Explore Rates by Social Context",
    x = "Social Context",
    y = "Proportion of Explore Decisions",
    color = "Monkey ID"
  ) +
  theme_minimal() +
  scale_y_continuous(labels = scales::percent)

# Print plots
print(p1)
print(p2)

# =============================================================================
# 4. BAYESIAN HIERARCHICAL MULTINOMIAL REGRESSION MODEL
# =============================================================================

# Set up priors
priors <- c(
  prior(normal(0, 1), class = Intercept),
  prior(normal(0, 0.5), class = b),
  prior(exponential(1), class = sd)
)

# Model 1: Main effects model
cat("\nFitting Model 1: Main effects only...\n")
model1 <- brm(
  decision_type ~ 1 + social_context + expected_explore_z + subjective_exploit_z + 
                  trial_num_z + relative_rank_f + trial_type_clean +
                  (1 | monkey_id) + (1 | block_id),
  data = data_clean,
  family = bernoulli(),
  prior = priors,
  chains = 4,
  iter = 2000,
  warmup = 1000,
  cores = 4,
  control = list(adapt_delta = 0.95),
  seed = 123
)

# Model 2: Interaction model
cat("\nFitting Model 2: With interaction between social context and expectation...\n")
model2 <- brm(
  decision_type ~ 1 + social_context * expected_explore_z + subjective_exploit_z + 
                  trial_num_z + relative_rank_f + trial_type_clean +
                  (1 + expected_explore_z | monkey_id) + (1 | block_id),
  data = data_clean,
  family = bernoulli(),
  prior = priors,
  chains = 4,
  iter = 2000,
  warmup = 1000,
  cores = 4,
  control = list(adapt_delta = 0.95),
  seed = 123
)

# Model 3: Full hierarchical model with varying slopes
cat("\nFitting Model 3: Full hierarchical model with varying slopes...\n")
model3 <- brm(
  decision_type ~ 1 + social_context * expected_explore_z + subjective_exploit_z + 
                  trial_num_z + relative_rank_f + trial_type_clean +
                  (1 + social_context + expected_explore_z | monkey_id) + 
                  (1 | block_id),
  data = data_clean,
  family = bernoulli(),
  prior = priors,
  chains = 4,
  iter = 2000,
  warmup = 1000,
  cores = 4,
  control = list(adapt_delta = 0.95),
  seed = 123
)

# =============================================================================
# 5. MODEL COMPARISON AND DIAGNOSTICS
# =============================================================================

# Model comparison using LOO-CV
loo1 <- loo(model1)
loo2 <- loo(model2)
loo3 <- loo(model3)

cat("\nModel Comparison (LOO-CV):\n")
print(loo_compare(loo1, loo2, loo3))

# MCMC diagnostics
cat("\nMCMC Diagnostics for best model:\n")
# Choose best model based on LOO comparison
best_model <- model2  # This will be updated based on actual results

# Check convergence
print(summary(best_model))

# Trace plots
p_trace <- plot(best_model, type = "trace")
print(p_trace)

# Posterior predictive checks
pp_check1 <- pp_check(best_model, ndraws = 100) +
  ggtitle("Posterior Predictive Check")
print(pp_check1)

# =============================================================================
# 6. RESULTS INTERPRETATION
# =============================================================================

# Extract and summarize posterior distributions
posterior_summary <- posterior_summary(best_model)
print("Posterior Summary:")
print(posterior_summary)

# Calculate probability that social context effects are meaningful
posterior_samples <- posterior_samples(best_model)

# Probability that duo > solo effect
prob_duo_greater <- mean(posterior_samples$b_social_contextduo > 0)
cat("\nProbability that duo context increases explore tendency vs solo:", 
    round(prob_duo_greater, 3), "\n")

# Probability that trio > solo effect
prob_trio_greater <- mean(posterior_samples$b_social_contexttrio > 0)
cat("Probability that trio context increases explore tendency vs solo:", 
    round(prob_trio_greater, 3), "\n")

# Effect of expectation
prob_expectation_positive <- mean(posterior_samples$b_expected_explore_z > 0)
cat("Probability that higher expectation increases explore tendency:", 
    round(prob_expectation_positive, 3), "\n")

# =============================================================================
# 7. VISUALIZATION OF RESULTS
# =============================================================================

# Plot fixed effects
p_fixed <- plot(best_model, type = "fixed") +
  ggtitle("Fixed Effects Posterior Distributions")
print(p_fixed)

# Conditional effects plots
p_cond1 <- conditional_effects(best_model, effects = "social_context")
p_cond2 <- conditional_effects(best_model, effects = "expected_explore_z")
p_cond3 <- conditional_effects(best_model, effects = "social_context:expected_explore_z")

print(p_cond1$social_context)
print(p_cond2$expected_explore_z)
print(p_cond3$`social_context:expected_explore_z`)

# Random effects (individual monkey effects)
p_random <- plot(best_model, type = "random") +
  ggtitle("Random Effects (Individual Monkeys)")
print(p_random)

# =============================================================================
# 8. ADDITIONAL ANALYSES
# =============================================================================

# Bayes factors for key hypotheses
# H1: Social context has an effect
hypothesis_social <- hypothesis(best_model, "social_contextduo > 0")
print("Hypothesis test - Duo vs Solo:")
print(hypothesis_social)

hypothesis_trio <- hypothesis(best_model, "social_contexttrio > 0")
print("Hypothesis test - Trio vs Solo:")
print(hypothesis_trio)

# H2: Expectation has an effect
hypothesis_expectation <- hypothesis(best_model, "expected_explore_z > 0")
print("Hypothesis test - Expectation effect:")
print(hypothesis_expectation)

# =============================================================================
# 9. SAVE RESULTS
# =============================================================================

# Save models
save(model1, model2, model3, best_model, 
     file = "bayesian_explore_exploit_models.RData")

# Save summary results
results_summary <- list(
  model_comparison = loo_compare(loo1, loo2, loo3),
  posterior_summary = posterior_summary,
  hypothesis_tests = list(
    social_duo = hypothesis_social,
    social_trio = hypothesis_trio,
    expectation = hypothesis_expectation
  ),
  probabilities = list(
    duo_greater_than_solo = prob_duo_greater,
    trio_greater_than_solo = prob_trio_greater,
    expectation_positive = prob_expectation_positive
  )
)

save(results_summary, file = "analysis_results_summary.RData")

# Export cleaned data
write.csv(data_clean, "cleaned_explore_exploit_data.csv", row.names = FALSE)

cat("\n=============================================================================\n")
cat("ANALYSIS COMPLETE\n")
cat("=============================================================================\n")
cat("Key findings:\n")
cat("1. Probability that duo context increases exploration vs solo:", 
    round(prob_duo_greater, 3), "\n")
cat("2. Probability that trio context increases exploration vs solo:", 
    round(prob_trio_greater, 3), "\n")
cat("3. Probability that higher expectation increases exploration:", 
    round(prob_expectation_positive, 3), "\n")
cat("\nModel files saved as: bayesian_explore_exploit_models.RData\n")
cat("Results summary saved as: analysis_results_summary.RData\n")
cat("Cleaned data saved as: cleaned_explore_exploit_data.csv\n") 